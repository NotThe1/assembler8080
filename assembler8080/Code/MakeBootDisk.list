0001: 0000                			                 
0002: 0000                ;**********************************************************************************	
0003: 0000                ;						Warm Boot    
0004: 0000                ;  On warm boot. the CCP and BDOS must be reloaded into memory.
0005: 0000                ; In this BIOS. only the 5 1/4" diskettes will be used.
0006: 0000                ; Therefore this code is hardware specific to the controller.
0007: 0000                ; Two prefabricated control tables are used.
0008: 0000                ;**********************************************************************************	
0009: 0000                                    
0010: 0000                CCPEntry		EQU		0E000H
0011: 0000                DiskStatusBlock	EQU		 0043H
0012: 0000                DisplayMessage	EQU		0F833H
0013: 0000                                    
0014: 0000                                    
0015: 0000                		ORG		01000H       
0016: 1000                CodeStart:          
0017: 1000                                    
0018: 1000                                    
0019: 1000                                    
0020: 1000                WBOOT:              
0021: 1000     318000     	LXI		SP,080H       
0022: 1003     116310     	LXI		D,BootControlPart1
0023: 1006     CD1010     	CALL	WarmBootRead  
0024: 1009                	                   
0025: 1009     117010     	LXi		D,BootControlPart2
0026: 100C     CD1010     	CALL	WarmBootRead  
0027: 100F                ;	JMP		EnterCPM     
0028: 100F     76         	HLT                
0029: 1010                	                   
0030: 1010                WarmBootRead:       
0031: 1010     215610     	LXI		H,FloppyCommand
0032: 1013     224600     	SHLD	CommandBlock5 
0033: 1016     0E0D       	MVI		C,13				; set byte count
0034: 1018                WarmByteMove:       
0035: 1018     1A         	LDAX	D             
0036: 1019     77         	MOV		M,A           
0037: 101A     23         	INX		H             
0038: 101B     13         	INX		D             
0039: 101C     0D         	DCR		C             
0040: 101D     C21810     	JNZ		WarmByteMove  
0041: 1020                	                   
0042: 1020     214500     	LXI		H,DiskControl5
0043: 1023     3680       	MVI		M,080H			; activate the controller
0044: 1025                	                   
0045: 1025                WaitForBootComplete:
0046: 1025     7E         	MOV		A,M           
0047: 1026     B7         	ORA		A             
0048: 1027     C22510     	JNZ		WaitForBootComplete
0049: 102A                	                   
0050: 102A     3A4300     	LDA		DiskStatusBlock
0051: 102D     FE80       	CPI		080H		; any errors ?
0052: 102F     DA3310     	JC		WarmBootError	; Yup
0053: 1032     C9         	RET                
0054: 1033                                    
0055: 1033                WarmBootError:      
0056: 1033     213C10     	LXI		H,WarmBootErroMessage
0057: 1036     CD33F8     	CALL	DisplayMessage
0058: 1039     C30010     	JMP		WBOOT         
0059: 103C                	                   
0060: 103C                WarmBootErroMessage:
0061: 103C     0D0A       	DB		0DH,0AH        
0062: 103E     5761726D20 	DB		057H,061H,072H,06DH,020H				; Warm
0063: 1043     426F6F7420 	DB		042H,06FH,06FH,074H,020H				; Boot
0064: 1048     7265744879696E67 	DB		072H,065H,074H,072,079H,069H,06EH,067H	;retrying
0065: 1050     2E2E2E0D0A 	DB		02EH,02EH,02EH,0DH,0AH
0066: 1055     00         	DB		00H            
0067: 1056                	                   
0068: 1056                DiskControl8	EQU	040H	; 8" control byte
0069: 1056                CommandBlock8	EQU	041H	; Control Table Pointer
0070: 1056                                    
0071: 1056                DiskStatusBlock	EQU	043H	; 8" and 5 1/4" status block
0072: 1056                                    
0073: 1056                DiskControl5	EQU	045H	; 8" control byte
0074: 1056                CommandBlock5	EQU	046H	; Control Table Pointer
0075: 1056                                    
0076: 1056                ;***************************************************************************
0077: 1056                ;					Floppy Disk Control tables
0078: 1056                ;***************************************************************************
0079: 1056     00         FloppyCommand:				DB	00H		; Command
0080: 1057                FloppyReadCode				EQU	01H
0081: 1057                FloppyWriteCode				EQU	02H
0082: 1057     00         FloppyUnit:					DB	00H		; unit (drive) number = 0 or 1
0083: 1058     00         FloppyHead:					DB	00H		; head number = 0 or 1
0084: 1059     00         FloppyTrack:				DB	00H		; track number
0085: 105A     00         FloppySector:				DB	00H		; sector number
0086: 105B     0000       FloppyByteCount:			DW	0000H	; number of bytes to read/write
0087: 105D     0000       FloppyDMAAddress:			DW	0000H	; transfer address
0088: 105F     0000       FloppyNextStatusBlock:		DW	0000H	; pointer to next status block
0089: 1061     0000       FloppyNextControlLocation:	DW	0000H	; pointer to next control byte
0090: 1063                	                   
0091: 1063                ;**********************************************************************************
0092: 1063                ;		Disk Control table image for warm boot
0093: 1063                ;**********************************************************************************
0094: 1063                BootControlPart1:   
0095: 1063     02         	DB	FloppyWriteCode	; Write function
0096: 1064     00         	DB	00H				; unit number
0097: 1065     00         	DB	00H				; head number
0098: 1066     00         	DB	00H				; track number
0099: 1067     02         	DB	02H				; Starting sector number
0100: 1068     0010       	DW	8 * 512			; Number of bytes to write
0101: 106A     00E0       	DW	CCPEntry		; write into this address
0102: 106C     4300       	DW	DiskStatusBlock	; pointer to next block
0103: 106E     4500       	DW	DiskControl5	; pointer to next table
0104: 1070                BootControlPart2:   
0105: 1070     02         	DB	FloppyWriteCode	; Write function
0106: 1071     00         	DB	00H				; unit number
0107: 1072     01         	DB	01H				; head number
0108: 1073     00         	DB	00H				; track number
0109: 1074     01         	DB	01H				; Starting sector number
0110: 1075                ;	DW	3 * 512			; Number of bytes to write
0111: 1075                ;	DW	9 * 512			; Number of bytes to write
0112: 1075     0010       	DW	8 * 512			; Number of bytes to write
0113: 1077     00F0       	DW	CCPEntry + ( 8 * 512)		; write into this address
0114: 1079     4300       	DW	DiskStatusBlock	; pointer to next block
0115: 107B     4500       	DW	DiskControl5	; pointer to next table
0116: 107D                                    
0117: 107D                ;                   
0118: 107D                CodeEnd:            
0119: 107D                	END                




                                    Xref


0000	0000	$                             		

0094	1063	BOOTCONTROLPART1              		  0022,
0104	1070	BOOTCONTROLPART2              		  0025,

0010	E000	CCPENTRY                      		  0101,  0113,
0118	107D	CODEEND                       		
0016	1000	CODESTART                     		
0074	0046	COMMANDBLOCK5                 		  0032,
0069	0041	COMMANDBLOCK8                 		

0073	0045	DISKCONTROL5                  		  0042,  0103,  0115,
0068	0040	DISKCONTROL8                  		
0011	0043	DISKSTATUSBLOCK               		  0050,  0102,  0114,
0012	F833	DISPLAYMESSAGE                		  0057,

0086	105B	FLOPPYBYTECOUNT               		
0079	1056	FLOPPYCOMMAND                 		  0031,
0087	105D	FLOPPYDMAADDRESS              		
0083	1058	FLOPPYHEAD                    		
0089	1061	FLOPPYNEXTCONTROLLOCATION     		
0088	105F	FLOPPYNEXTSTATUSBLOCK         		
0080	0001	FLOPPYREADCODE                		
0085	105A	FLOPPYSECTOR                  		
0084	1059	FLOPPYTRACK                   		
0082	1057	FLOPPYUNIT                    		
0081	0002	FLOPPYWRITECODE               		  0095,  0105,

0045	1025	WAITFORBOOTCOMPLETE           		  0048,
0060	103C	WARMBOOTERROMESSAGE           		  0056,
0055	1033	WARMBOOTERROR                 		  0052,
0030	1010	WARMBOOTREAD                  		  0023,  0026,
0034	1018	WARMBYTEMOVE                  		  0040,
0020	1000	WBOOT                         		  0058,
