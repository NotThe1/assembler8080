0001: 0000 		 			
0002: 0000 		 ;**********************************************************************************	
0003: 0000 		 ;						Warm Boot
0004: 0000 		 ;  On warm boot. the CCP and BDOS must be reloaded into memory.
0005: 0000 		 ; In this BIOS. only the 5 1/4" diskettes will be used.
0006: 0000 		 ; Therefore this code is hardware specific to the controller.
0007: 0000 		 ; Two prefabricated control tables are used.
0008: 0000 		 ;**********************************************************************************	
0009: 0000 		 
0010: 0000 		 CCPEntry		EQU		0E000H
0011: 0000 		 DiskStatusBlock	EQU		 0043H
0012: 0000 		 DisplayMessage	EQU		0F833H
0013: 0000 		 
0014: 0000 		 
0015: 0000 		 		ORG		01000H
0016: 1000 		 
0017: 1000 		 
0018: 1000 		 
0019: 1000 		 WBOOT:
0020: 1000 	318000	 	LXI		SP,080H
0021: 1003 	116310	 	LXI		D,BootControlPart1
0022: 1006 	CD1010	 	CALL	WarmBootRead
0023: 1009 		 	
0024: 1009 	117010	 	LXi		D,BootControlPart2
0025: 100C 	CD1010	 	CALL	WarmBootRead
0026: 100F 		 ;	JMP		EnterCPM
0027: 100F 	76	 	HLT
0028: 1010 		 	
0029: 1010 		 WarmBootRead:
0030: 1010 	215610	 	LXI		H,FloppyCommand
0031: 1013 	224600	 	SHLD	CommandBlock5
0032: 1016 	0E0D	 	MVI		C,13				; set byte count
0033: 1018 		 WarmByteMove:
0034: 1018 	1A	 	LDAX	D
0035: 1019 	77	 	MOV		M,A
0036: 101A 	23	 	INX		H
0037: 101B 	13	 	INX		D
0038: 101C 	0D	 	DCR		C
0039: 101D 	C21810	 	JNZ		WarmByteMove
0040: 1020 		 	
0041: 1020 	214500	 	LXI		H,DiskControl5
0042: 1023 	3680	 	MVI		M,080H			; activate the controller
0043: 1025 		 	
0044: 1025 		 WaitForBootComplete:
0045: 1025 	7E	 	MOV		A,M
0046: 1026 	B7	 	ORA		A
0047: 1027 	C22510	 	JNZ		WaitForBootComplete
0048: 102A 		 	
0049: 102A 	3A4300	 	LDA		DiskStatusBlock
0050: 102D 	FE80	 	CPI		080H		; any errors ?
0051: 102F 	DA3310	 	JC		WarmBootError	; Yup
0052: 1032 	C9	 	RET
0053: 1033 		 
0054: 1033 		 WarmBootError:
0055: 1033 	213C10	 	LXI		H,WarmBootErroMessage
0056: 1036 	CD33F8	 	CALL	DisplayMessage
0057: 1039 	C30010	 	JMP		WBOOT
0058: 103C 		 	
0059: 103C 		 WarmBootErroMessage:
0060: 103C 	0D0A	 	DB		0DH,0AH
0061: 103E 	5761726D20	 	DB		057H,061H,072H,06DH,020H				; Warm
0062: 1043 	426F6F7420	 	DB		042H,06FH,06FH,074H,020H				; Boot
0063: 1048 	7265744879696E67	 	DB		072H,065H,074H,072,079H,069H,06EH,067H	;retrying
0064: 1050 	2E2E2E0D0A	 	DB		02EH,02EH,02EH,0DH,0AH
0065: 1055 	00	 	DB		00H
0066: 1056 		 	
0067: 1056 		 DiskControl8	EQU	040H	; 8" control byte
0068: 1056 		 CommandBlock8	EQU	041H	; Control Table Pointer
0069: 1056 		 
0070: 1056 		 DiskStatusBlock	EQU	043H	; 8" and 5 1/4" status block
0071: 1056 		 
0072: 1056 		 DiskControl5	EQU	045H	; 8" control byte
0073: 1056 		 CommandBlock5	EQU	046H	; Control Table Pointer
0074: 1056 		 
0075: 1056 		 ;***************************************************************************
0076: 1056 		 ;					Floppy Disk Control tables
0077: 1056 		 ;***************************************************************************
0078: 1056 	00	 FloppyCommand:	DB	00H		; Command
0079: 1057 		 FloppyReadCode	EQU	01H
0080: 1057 		 FloppyWriteCode	EQU	02H
0081: 1057 	00	 FloppyUnit:		DB	00H		; unit (drive) number = 0 or 1
0082: 1058 	00	 FloppyHead:		DB	00H		; head number = 0 or 1
0083: 1059 	00	 FloppyTrack:	DB	00H		; track number
0084: 105A 	00	 FloppySector:	DB	00H		; sector number
0085: 105B 	0000	 FloppyByteCount:	DW	0000H	; number of bytes to read/write
0086: 105D 	0000	 FloppyDMAAddress:	DW	0000H	; transfer address
0087: 105F 	0000	 FloppyNextStatusBlock:	DW	0000H	; pointer to next status block
0088: 1061 	0000	 FloppyNextControlLocation:	DW	0000H	; pointer to next control byte
0089: 1063 		 	
0090: 1063 		 ;**********************************************************************************
0091: 1063 		 ;		Disk Control table image for warm boot
0092: 1063 		 ;**********************************************************************************
0093: 1063 		 BootControlPart1:
0094: 1063 	02	 	DB	FloppyWriteCode	; Read function
0095: 1064 	00	 	DB	00H				; unit number
0096: 1065 	00	 	DB	00H				; head number
0097: 1066 	00	 	DB	00H				; track number
0098: 1067 	02	 	DB	02H				; Starting sector number
0099: 1068 	0010	 	DW	8 * 512			; Number of bytes to read
0100: 106A 	00E0	 	DW	CCPEntry		; read into this address
0101: 106C 	4300	 	DW	DiskStatusBlock	; pointer to next block
0102: 106E 	4500	 	DW	DiskControl5	; pointer to next table
0103: 1070 		 BootControlPart2:
0104: 1070 	02	 	DB	FloppyWriteCode	; Read function
0105: 1071 	00	 	DB	00H				; unit number
0106: 1072 	01	 	DB	01H				; head number
0107: 1073 	00	 	DB	00H				; track number
0108: 1074 	01	 	DB	01H				; Starting sector number
0109: 1075 	0006	 	DW	3 * 512			; Number of bytes to read
0110: 1077 	00F0	 	DW	CCPEntry + ( 8 * 512)		; read into this address
0111: 1079 	4300	 	DW	DiskStatusBlock	; pointer to next block
0112: 107B 	4500	 	DW	DiskControl5	; pointer to next table
0113: 107D 		 
0114: 107D 		 ;
0115: 107D 		 End:




                                    Xref


0000	0000	$                             		

0093	1063	BOOTCONTROLPART1              		  0021,
0103	1070	BOOTCONTROLPART2              		  0024,

0010	E000	CCPENTRY                      		  0100,  0110,
0073	0046	COMMANDBLOCK5                 		  0031,
0068	0041	COMMANDBLOCK8                 		

0072	0045	DISKCONTROL5                  		  0041,  0102,  0112,
0067	0040	DISKCONTROL8                  		
0011	0043	DISKSTATUSBLOCK               		  0049,  0101,  0111,
0012	F833	DISPLAYMESSAGE                		  0056,

0115	107D	END                           		

0085	105B	FLOPPYBYTECOUNT               		
0078	1056	FLOPPYCOMMAND                 		  0030,
0086	105D	FLOPPYDMAADDRESS              		
0082	1058	FLOPPYHEAD                    		
0088	1061	FLOPPYNEXTCONTROLLOCATION     		
0087	105F	FLOPPYNEXTSTATUSBLOCK         		
0079	0001	FLOPPYREADCODE                		
0084	105A	FLOPPYSECTOR                  		
0083	1059	FLOPPYTRACK                   		
0081	1057	FLOPPYUNIT                    		
0080	0002	FLOPPYWRITECODE               		  0094,  0104,

0044	1025	WAITFORBOOTCOMPLETE           		  0047,
0059	103C	WARMBOOTERROMESSAGE           		  0055,
0054	1033	WARMBOOTERROR                 		  0051,
0029	1010	WARMBOOTREAD                  		  0022,  0025,
0033	1018	WARMBYTEMOVE                  		  0039,
0019	1000	WBOOT                         		  0057,
