0001: 0000                ;BootLoader.asm     
0002: 0000                ;                   
0003: 0000                ; the actual boot code starts at Location 0100.
0004: 0000                ; to write it to disk start program at location 0200
0005: 0000                ;                   
0006: 0000                CodeStart:          
0007: 0000                                    
0008: 0000                DiskStatusBlock		EQU		0043H
0009: 0000                DiskControl			EQU		0045H
0010: 0000                CommandBlock		EQU		0046H
0011: 0000                                    
0012: 0000                                    
0013: 0000                BDOSEntry			EQU		0E806H
0014: 0000                DiskControlTable	EQU		0040H
0015: 0000                ;CommandBlock		EQU		0046H
0016: 0000                BIOSStart			EQU		0F600H
0017: 0000                WarmBootEntry		EQU		BIOSStart +3
0018: 0000                                    
0019: 0000                CR			EQU		0DH		; Carriage Return
0020: 0000                LF			EQU		0AH		; Line Feed
0021: 0000                EndOfMessage	EQU	00H
0022: 0000                                    
0023: 0000                                    
0024: 0000                	ORG		0100H         
0025: 0100                Start:              
0026: 0100     31FF00     	LXI		SP,Start-1				; stack goes down from here
0027: 0103     CD9101     	CALL	SendBootMessage			; display boot message
0028: 0106     063B       	MVI		B,Page0End-Page0Start	; Size of code to move
0029: 0108     213C01     	LXI		H,Page0Start			; Source of page 0 code
0030: 010B     110000     	LXI		D,0000					; Location 0, the target
0031: 010E                ;   Move (B) bytes from (HL) to (DE).
0032: 010E                HL2DE:              
0033: 010E     7E         	MOV		A,M           
0034: 010F     12         	STAX	D             
0035: 0110     23         	INX		H             
0036: 0111     13         	INX		D             
0037: 0112     05         	DCR		B             
0038: 0113     C20E01     	JNZ		HL2DE         
0039: 0116                                    
0040: 0116     212F01     	LXI		H,BootControl 
0041: 0119     224600     	SHLD	CommandBlock		; put it into the Command block for drive A:
0042: 011C                                    
0043: 011C                                    
0044: 011C     214500     	LXI		H,DiskControl 
0045: 011F     3680       	MVI		M,080H				; activate the controller 
0046: 0121                	                   
0047: 0121                WaitForBootComplete:
0048: 0121     7E         	MOV		A,M					; Get the control byte
0049: 0122     B7         	ORA		A					; is it set to 0 (Completed operation) ?
0050: 0123     C22101     	JNZ		WaitForBootComplete	; if not try again
0051: 0126                	                   
0052: 0126     3A4300     	LDA		DiskStatusBlock		; after operation what's the status?
0053: 0129     FE80       	CPI		080H				; any errors ?
0054: 012B                	                   
0055: 012B                                    
0056: 012B                	                   
0057: 012B     D20000     	JNC		0000				; now do a warm boot
0058: 012E                			; else we have a problem		
0059: 012E                                    
0060: 012E     76         	HLT                
0061: 012F                ;---------------------------------------------------	
0062: 012F                                    
0063: 012F                BootControl:        
0064: 012F     01         	DB		01H				; Read function
0065: 0130     00         	DB		00H				; unit number
0066: 0131     01         	DB		01H				; head number
0067: 0132     00         	DB		00H				; track number
0068: 0133     04         	DB		04H				; Starting sector number ()
0069: 0134     000A       	DW		5 * 512			; Number of bytes to read ( rest of the head)
0070: 0136     00F6       	DW		BIOSStart		; read into this address
0071: 0138     4300       	DW		DiskStatusBlock	; pointer to next block - no linking
0072: 013A     4000       	DW		DiskControlTable		; pointer to next table- no linking
0073: 013C                                    
0074: 013C                ;---------------------------------------------------	
0075: 013C                                    
0076: 013C                Page0Start:         
0077: 013C     C303F6     	JMP		WarmBootEntry	; warm start
0078: 013F                IOBYTE:             
0079: 013F     01         	DB		01H				; IOBYTE- Console is assigned the CRT device
0080: 0140                DefaultDisk:        
0081: 0140     00         	DB		00H				; Current default drive (A)
0082: 0141     C306E8     	JMP		BDOSEntry		; jump to BDOS entry
0083: 0144                	DS		028H			; interrupt locations 1-5 not used
0084: 016C                	DS		008H			; interrupt location 6 is reserved
0085: 0174     C30000     	JMP		0000H			; rst 7 used only by DDT & SID programs
0086: 0177                Page0End:           
0087: 0177                                    
0088: 0177                ;---------------------------------------------------
0089: 0177                                    
0090: 0177                	                   
0091: 0177                BootMessage:        
0092: 0177     0D0A       	DB		CR,LF          
0093: 0179     43502F4D20424F4F545354524150 	DB		'CP/M BootStrap'
0094: 0187     204C4F41444552 	DB		' loader'      
0095: 018E     0D0A00     	DB		CR,LF,EndOfMessage
0096: 0191                	                   
0097: 0191                SendBootMessage:    
0098: 0191     217701     	LXI		H,BootMessage 
0099: 0194                SendMessage1:       
0100: 0194     7E         	MOV		A,M           
0101: 0195     B7         	ORA		A             
0102: 0196     C8         	RZ                 
0103: 0197     D301       	OUT		01            
0104: 0199     23         	INX		H             
0105: 019A     C39401     	JMP		SendMessage1  
0106: 019D                	                   
0107: 019D                WriteMessage:       
0108: 019D     0D0A       	DB		CR,LF          
0109: 019F     2054484520424F4F5420534543544F52 	DB		' The Boot Sector'
0110: 01AF     20484153204245454E205752495454454E 	DB		' has been written'
0111: 01C0     0D0A00     	DB		CR,LF,EndOfMessage
0112: 01C3                ;---------------------------------------------------	
0113: 01C3                                    
0114: 01C3                	ORG		512				; past the first sector - write boot record out
0115: 0200                	                   
0116: 0200                ;---------------------------------------------------
0117: 0200                Begin:	             
0118: 0200     31FF00     	LXI		SP,Start-1			; stack goes down from here
0119: 0203     211F02     	LXI		H,WriteCommand
0120: 0206     224600     	SHLD	CommandBlock		; put it into the Command block for drive A:
0121: 0209                                    
0122: 0209     214500     	LXI		H,DiskControl 
0123: 020C     3680       	MVI		M,080H				; activate the controller 
0124: 020E                	                   
0125: 020E                WaitForWriteComplete:
0126: 020E     7E         	MOV		A,M					; Get the control byte
0127: 020F     B7         	ORA		A					; is it set to 0 (Completed operation) ?
0128: 0210     C20E02     	JNZ		WaitForWriteComplete	; if not try again
0129: 0213                	                   
0130: 0213     3A4300     	LDA		DiskStatusBlock		; after operation what's the status?
0131: 0216     FE80       	CPI		080H				; any errors ?
0132: 0218                	                   
0133: 0218                                    
0134: 0218     219D01     	LXI		H,WriteMessage
0135: 021B     D49401     	CNC		SendMessage1	 
0136: 021E                ;	JNC		0000				; now do a warm boot
0137: 021E                			; else we have a problem		
0138: 021E                                    
0139: 021E     76         	HLT                
0140: 021F                WriteCommand:       
0141: 021F     02         	DB		02H				; Write function
0142: 0220     00         	DB		00H				; unit number
0143: 0221     00         	DB		00H				; head number
0144: 0222     00         	DB		00H				; track number
0145: 0223     01         	DB		01H				; Starting sector number (First one)
0146: 0224     0002       	DW		1 * 512			; Number of bytes to write (Boot sector)
0147: 0226     0001       	DW		Start			; write from this address
0148: 0228     4300       	DW		DiskStatusBlock	; pointer to next block - no linking
0149: 022A     4000       	DW		DiskControlTable	; pointer to next table- no linking
0150: 022C                                    
0151: 022C                ;---------------------------------------------------
0152: 022C                CodeEnd:            




                                    Xref


0000	0000	$                             		

0013	E806	BDOSENTRY                     		  0082,
0117	0200	BEGIN                         		
0016	F600	BIOSSTART                     		  0017,  0070,
0063	012F	BOOTCONTROL                   		  0040,
0091	0177	BOOTMESSAGE                   		  0098,

0152	022C	CODEEND                       		
0006	0000	CODESTART                     		
0010	0046	COMMANDBLOCK                  		  0041,  0120,
0019	000D	CR                            		  0092,  0095,  0108,  0111,

0080	0140	DEFAULTDISK                   		
0009	0045	DISKCONTROL                   		  0044,  0122,
0014	0040	DISKCONTROLTABLE              		  0072,  0149,
0008	0043	DISKSTATUSBLOCK               		  0052,  0071,  0130,  0148,

0021	0000	ENDOFMESSAGE                  		  0095,  0111,

0032	010E	HL2DE                         		  0038,

0078	013F	IOBYTE                        		

0020	000A	LF                            		  0092,  0095,  0108,  0111,

0086	0177	PAGE0END                      		  0028,
0076	013C	PAGE0START                    		  0028,  0029,

0097	0191	SENDBOOTMESSAGE               		  0027,
0099	0194	SENDMESSAGE1                  		  0105,  0135,
0025	0100	START                         		  0026,  0118,  0147,

0047	0121	WAITFORBOOTCOMPLETE           		  0050,
0125	020E	WAITFORWRITECOMPLETE          		  0128,
0017	F603	WARMBOOTENTRY                 		  0077,
0140	021F	WRITECOMMAND                  		  0119,
0107	019D	WRITEMESSAGE                  		  0134,
